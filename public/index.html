<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PDF Quiz Generator</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 900px; margin: auto; padding: 20px; }
  h1 { text-align: center; }
  .btn {
    padding: 10px 20px; background: #007BFF; color: white;
    border: none; border-radius: 5px; cursor: pointer; margin-right: 5px;
  }
  .btn:disabled { background: #cccccc; cursor: not-allowed; }
  #quizContainer {
    margin-top: 20px;
    overflow-x: auto;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 6px 8px;
    text-align: left;
  }
  th {
    background-color: #007BFF;
    color: white;
    position: sticky;
    top: 0;
    z-index: 1;
  }
  #loadingIndicator {
    display: none;
    margin-top: 10px;
    font-weight: bold;
    color: #007BFF;
  }
</style>
</head>
<body>

<h1>PDF Quiz Generator</h1>
<input type="file" id="pdfInput" accept="application/pdf" /><br /><br />
<button id="generateQuizBtn" class="btn" disabled>Generate Quiz</button>
<button id="copyQuizBtn" class="btn" disabled>Copy Quiz</button>
<button id="downloadQuizBtn" class="btn" disabled>Download Quiz</button>

<div id="loadingIndicator">Generating quiz... Please wait.</div>
<div id="quizContainer"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
<script>
  let extractedText = "";
  let generatedQuizRaw = "";

  const generateQuizBtn = document.getElementById("generateQuizBtn");
  const copyQuizBtn = document.getElementById("copyQuizBtn");
  const downloadQuizBtn = document.getElementById("downloadQuizBtn");
  const quizContainer = document.getElementById("quizContainer");
  const loadingIndicator = document.getElementById("loadingIndicator");

  document.getElementById("pdfInput").addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (file) {
      extractedText = await extractPDFText(file);
      alert("PDF text extracted successfully!");
      generateQuizBtn.disabled = false;
    }
  });

  async function extractPDFText(file) {
    const reader = new FileReader();
    return new Promise((resolve) => {
      reader.onload = async function () {
        const typedArray = new Uint8Array(this.result);
        const pdf = await pdfjsLib.getDocument(typedArray).promise;
        let text = "";
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          const pageText = content.items.map((item) => item.str).join(" ");
          text += pageText + "\n";
        }
        resolve(text);
      };
      reader.readAsArrayBuffer(file);
    });
  }

  generateQuizBtn.addEventListener("click", async () => {
    const numQuestions = prompt("How many quiz questions to generate?");
    if (!numQuestions || isNaN(numQuestions)) return alert("Please enter a valid number.");

    loadingIndicator.style.display = "block";
    generateQuizBtn.disabled = true;
    copyQuizBtn.disabled = true;
    downloadQuizBtn.disabled = true;
    quizContainer.innerHTML = "";

    try {
      generatedQuizRaw = await generateQuiz(extractedText, numQuestions);
      renderQuizTable(generatedQuizRaw);
      copyQuizBtn.disabled = false;
      downloadQuizBtn.disabled = false;
    } catch (err) {
      alert("Failed to generate quiz.");
    } finally {
      loadingIndicator.style.display = "none";
      generateQuizBtn.disabled = false;
    }
  });

  async function generateQuiz(text, numQuestions) {
    const backendUrl = "/generate-quiz";

    const response = await fetch(backendUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text, numQuestions }),
    });

    if (!response.ok) {
      throw new Error("API error");
    }

    const data = await response.json();
    return data.quiz || "Failed to generate quiz.";
  }

  function renderQuizTable(rawText) {
    // rawText is tab-separated values like:
    // title\timage\tthumbnail\tvideo\taudio\texplanation ... (header)
    // row1
    // row2
    // ...

    if (!rawText.trim()) {
      quizContainer.innerHTML = "<p>No quiz generated.</p>";
      return;
    }

    const lines = rawText.trim().split("\n");
    if (lines.length === 0) {
      quizContainer.innerHTML = "<p>No quiz generated.</p>";
      return;
    }

    const table = document.createElement("table");

    // Create header
    const headers = lines[0].split("\t");
    const thead = document.createElement("thead");
    const headerRow = document.createElement("tr");
    headers.forEach((h) => {
      const th = document.createElement("th");
      th.textContent = h;
      headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);

    // Create body
    const tbody = document.createElement("tbody");
    for (let i = 1; i < lines.length; i++) {
      const row = document.createElement("tr");
      const cols = lines[i].split("\t");
      cols.forEach((col) => {
        const td = document.createElement("td");
        td.textContent = col;
        row.appendChild(td);
      });
      tbody.appendChild(row);
    }
    table.appendChild(tbody);

    quizContainer.innerHTML = "";
    quizContainer.appendChild(table);
  }

  copyQuizBtn.addEventListener("click", () => {
    if (generatedQuizRaw) {
      navigator.clipboard
        .writeText(generatedQuizRaw)
        .then(() => alert("Quiz copied to clipboard!"))
        .catch(() => alert("Failed to copy quiz."));
    }
  });

  downloadQuizBtn.addEventListener("click", () => {
    if (generatedQuizRaw) {
      const blob = new Blob([generatedQuizRaw], { type: "text/plain" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "quiz.txt";
      link.click();
    }
  });
</script>

</body>
</html>
